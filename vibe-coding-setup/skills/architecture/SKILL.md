---
name: architecture
description: Generate or update the project ARCHITECTURE.md with current codebase structure, key patterns, data flow, and component relationships. Use when architecture changes, after major features, or when asked to document architecture. Triggers on "update architecture", "architecture diagram", "document the architecture", "how is this structured".
invocation: auto
allowed_tools:
  - Read
  - Write
  - Edit
  - Grep
  - Glob
  - Bash
---

# Architecture Documentation

Generate or update `.claude/ARCHITECTURE.md` as a concise quick-reference for the project's structure, patterns, and data flow.

Accept `$ARGUMENTS` as an optional focus area (e.g., "database", "api", "frontend"). Default: full project scan.

---

## TTS Notifications

All `**TTS**` markers in this skill should be spoken via `.claude/hooks/play-tts.sh` if available, otherwise fall back to macOS `say` command.

---

## Phase 1: SCAN

**Goal**: Understand the current project architecture.

**Actions**:

1. **Package & Dependencies**
   - Read `package.json` for name, dependencies, scripts, and version
   - Detect monorepo: check for `pnpm-workspace.yaml`, `turbo.json`, or `lerna.json`
   - Identify key frameworks from dependencies (next, svelte, vendure, express, etc.)

2. **Directory Structure**
   - Scan top-level directories: `src/`, `app/`, `lib/`, `components/`, `api/`, `pages/`, `routes/`, `server/`, `packages/`
   - Note special directories: `migrations/`, `prisma/`, `supabase/`, `public/`, `static/`
   - Count files per key directory for size context

3. **Framework Patterns**
   - Next.js: Check for `app/` (App Router) vs `pages/` (Pages Router), detect server actions, middleware
   - SvelteKit: Check for `src/routes/`, `+page.svelte`, `+server.ts` patterns
   - Vendure: Check for `src/plugins/`, custom entities, GraphQL extensions
   - Express/Fastify: Check for route registration patterns

4. **Database & Data Layer**
   - Prisma: Read `prisma/schema.prisma` for models
   - Supabase: Check for `supabase/migrations/`, generated types in `database.types.ts`
   - Turso: Check for `drizzle/` schema or `libsql` usage
   - TypeORM: Check for `*.entity.ts` files
   - List key tables/models found

5. **API Surface**
   - Find route handlers: `route.ts`, `+server.ts`, `*.controller.ts`
   - Find GraphQL resolvers or schema definitions
   - Count total endpoints

6. **Component Hierarchy** (if frontend exists)
   - Identify layout components (`layout.tsx`, `+layout.svelte`)
   - Find page components
   - Identify shared/ui components directory
   - Note component library usage (shadcn, Skeleton, etc.)

**TTS**: `"Architecture scan complete."`

---

## Phase 2: GENERATE or UPDATE

**Goal**: Write or update `.claude/ARCHITECTURE.md`.

### If file does NOT exist: Generate fresh

Create `.claude/ARCHITECTURE.md` with this template:

```markdown
# Architecture: [Project Name]

## System Overview

[One paragraph: what the system does, who it serves, how it works at a high level]

## Tech Stack

| Layer           | Technology          | Version   |
| --------------- | ------------------- | --------- |
| Frontend        | [framework]         | [version] |
| Backend         | [service/framework] | [version] |
| Database        | [database]          | -         |
| Deploy          | [platform]          | -         |
| Package Manager | [pnpm/yarn/npm]     | -         |

## Directory Structure
```

[project root]/
src/ # [description]
app/ # [description]
components/ # [description]
lib/ # [description]
...

```

## Data Flow
```

[User] -> [Frontend] -> [API Layer] -> [Database]
-> [External Services]

```

## Key Patterns
- [Pattern 1 with brief explanation]
- [Pattern 2 with brief explanation]
- [Pattern 3 with brief explanation]

## Database Schema (key tables)
| Table/Model | Purpose | Key Fields |
|-------------|---------|------------|
| [name] | [purpose] | [important columns] |

## API Endpoints
| Route | Method | Purpose |
|-------|--------|---------|
| [path] | [GET/POST/etc] | [what it does] |

## Component Map
- **Layouts**: [list key layouts]
- **Pages**: [list key pages]
- **Shared**: [list reusable components]

## Recent Changes
- [YYYY-MM-DD]: Initial architecture documentation

_Auto-generated by architecture skill. Last updated: YYYY-MM-DD_
```

### If file ALREADY exists: Update in place

1. Read the existing `.claude/ARCHITECTURE.md`
2. Compare scanned results against each section
3. Only update sections where architecture has changed:
   - New dependencies in Tech Stack
   - New directories in Directory Structure
   - New endpoints in API Endpoints
   - New models in Database Schema
   - New components in Component Map
4. Add entry to "Recent Changes" with today's date and what changed
5. Do NOT rewrite unchanged sections
6. Use the `Edit` tool for targeted updates, not `Write` for full replacement

**TTS**: `"Architecture document updated."`

---

## Phase 3: VALIDATE

**Goal**: Ensure the document is concise and accurate.

**Actions**:

1. Count total lines in `.claude/ARCHITECTURE.md`
2. If over 150 lines:
   - Warn: "ARCHITECTURE.md is [N] lines. Consider splitting detailed sections into separate docs."
   - Suggest moving detailed API docs to `API.md`, schema details to `SCHEMA.md`
3. Verify all referenced directories actually exist
4. Verify tech stack versions match `package.json`

**Validation Gate**:

- [ ] File exists at `.claude/ARCHITECTURE.md`
- [ ] Under 150 lines (warn if over, do not block)
- [ ] All referenced paths exist in project
- [ ] Tech stack versions are accurate

**TTS**: `"Architecture updated."`

---

## Conciseness Rules

Keep the document tight:

- **System Overview**: Max 3 sentences
- **Tech Stack**: Only include layers that exist (skip empty rows)
- **Directory Structure**: Only top 2 levels, skip `node_modules`, `.next`, build dirs
- **Data Flow**: One ASCII diagram, max 4 lines
- **Key Patterns**: Max 5 bullet points, one line each
- **Database Schema**: Only tables with business logic (skip migrations, sessions)
- **API Endpoints**: Group by resource, max 15 rows. If more, link to separate doc
- **Component Map**: Only structural components, not every button/icon
- **Recent Changes**: Keep last 5 entries, archive older ones

Target: 50-100 lines for small projects, up to 150 for large ones.

---

## Integration Points

This skill is triggered by:

- `/session-end` command (auto-update if architecture changed during session)
- Direct user request ("update architecture", "document the architecture")
- After major features that add new routes, tables, or components

---

## Mode Awareness

Adapt output to the active workflow mode:

- **BMM Mode**: Include epic/story context in System Overview
- **Features Mode**: Reference feature specs in Recent Changes
- **Solo Mode**: Keep it minimal, focus on what matters for solo dev

---

## Context Files

```
context_files:
  - .claude/CLAUDE.md
  - .claude/ARCHITECTURE.md (if exists)
  - package.json
```
